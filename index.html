<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Transline Cargo & Logistics – Shipment Tracking</title>
  <meta name="description" content="International & domestic courier, business cargo, and last-mile delivery with live shipment tracking." />

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net/" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{
      --brand:#0B3B8C; --brand-2:#134fb6; --accent:#E11D48;
      --ink:#0f172a; --muted:#6b7280; --soft:#f6f8fb;
      --header:#eef4ff; --ring:#e5e7eb; --card:#ffffff; --footer:#0a2e6e;
      --wa:#25D366;
    }
    html,body{ background:#fff; color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    a{text-decoration:none}

    /* Header */
    header{ background:var(--header); border-bottom:1px solid var(--ring); transition:box-shadow .18s ease; }
    header.scrolled{ box-shadow:0 8px 24px rgba(12,27,77,.1); }
    .navbar{ --bs-navbar-padding-y:.25rem; }
    .navbar .nav-link{ color:#1b2b52; font-weight:500; }
    .navbar .nav-link:hover{ color:var(--brand); }
    .navbar-toggler-icon{
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3E%3Cpath stroke='rgba(17,24,39,0.85)' stroke-linecap='round' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E");
    }
    .logo img{ height:88px; width:auto; }
    @media (min-width:992px){ .logo img{ height:96px; } }

    /* Hero */
    .hero{ background:linear-gradient(0deg,#fff,var(--soft)); }
    .card-soft{ background:var(--card); border:1px solid var(--ring); border-radius:16px; box-shadow:0 6px 18px rgba(2,18,54,.05); }
    .btn-brand{ background:var(--brand); color:#fff; border:none; }
    .btn-brand:hover{ background:var(--brand-2); color:#fff; }
    .btn-outline-dim{ border-color:#cbd5e1; color:#334155; }
    .btn-outline-dim:hover{ background:#f8fafc; }
    .hero-badge{ display:inline-flex; gap:.5rem; align-items:center; background:#edf2ff; color:#1d4ed8; border:1px solid #dbeafe; padding:.35rem .6rem; border-radius:999px; font-size:.8rem; }
    .hero-badge i{ width:8px; height:8px; border-radius:50%; display:inline-block; background:var(--brand); }
    .banner img{ width:100%; height:340px; object-fit:cover; border-radius:16px; }
    @media (min-width:992px){ .banner img{ height:380px; } }

    /* Features */
    .feature{ display:flex; gap:.9rem; align-items:flex-start; padding:1rem; border:1px solid var(--ring); border-radius:14px; background:#fff; height:100%; transition:transform .12s, box-shadow .12s; }
    .feature:hover{ transform:translateY(-2px); box-shadow:0 6px 24px rgba(2,18,54,.06); }
    .f-ico{ width:42px; height:42px; border-radius:12px; background:#eff6ff; display:grid; place-items:center; flex:0 0 auto; }

    /* Modal tracking UI */
    .summary-grid .k{ font-size:.75rem; color:var(--muted); }
    .summary-grid .v{ font-weight:600; color:#0b1220; }
    .timeline{ border-left:4px solid var(--ring); margin-left:.25rem; }
    .timeline-item{ position:relative; padding-left:1rem; margin-left:.25rem; }
    .timeline-item::before{ content:""; position:absolute; left:-10px; top:.55rem; width:10px; height:10px; border-radius:50%; background:var(--accent); }
    .scroll-section{ max-height:60vh; overflow:auto; }
    @media (min-width:992px){ .scroll-section{ max-height:55vh; } }

    /* Skeleton */
    .skeleton{ position:relative; overflow:hidden; background:#f3f4f6; border-radius:.5rem; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent); animation:shimmer 1.1s infinite; }
    @keyframes shimmer{ 100%{ transform:translateX(100%);} }

    /* Footer */
    footer{ background:var(--footer); color:#fff; }
    .footer-logo img{ height:86px; width:auto; }

    html{ scroll-behavior:smooth; }
    .chev{ transition:transform .18s; } .brands a:hover .chev{ transform:translateX(2px); }

    /* WhatsApp floating widget */
    .wa-widget{
      position: fixed; right: 16px; bottom: 16px; z-index: 1050;
      display:flex; flex-direction:column; align-items:flex-end; gap:.5rem;
    }
    .wa-bubble{
      background: var(--wa); color:#fff; border-radius:999px; box-shadow:0 8px 20px rgba(0,0,0,.2);
      display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; cursor:pointer;
      transition: transform .12s ease;
    }
    .wa-bubble:hover{ transform: translateY(-1px); }
    .wa-bubble svg{ width:22px; height:22px; flex:0 0 auto; }
    .wa-hint{
      background:#111827; color:#fff; font-size:.8rem; padding:.35rem .6rem; border-radius:8px; opacity:.92;
    }
    @media (max-width: 576px){
      .wa-bubble{ padding:.55rem .8rem; }
      .wa-bubble span{ display:none; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="sticky-top" id="siteHeader">
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2 logo" href="/">
          <img src="/assets/trl.png" alt="Transline Logo (Blue)" />
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div id="topnav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto align-items-lg-center">
            <li class="nav-item"><a class="nav-link" href="#services">Services</a></li>
            <li class="nav-item ms-lg-3"><a class="nav-link" href="#brands">Brands</a></li>
            <li class="nav-item ms-lg-3"><a class="nav-link" href="#presence">Presence</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Hero -->
  <section class="hero py-4 py-lg-5">
    <div class="container">
      <div class="row g-4 align-items-stretch">
        <!-- Tracking -->
        <div class="col-lg-5">
          <div class="card-soft p-4 h-100">
            <span class="hero-badge mb-2"><i></i> Live shipment tracking</span>
            <h1 class="h4 fw-bold mt-2">Track your shipment</h1>
            <p class="text-muted mb-3">Enter your <strong>Order ID</strong>. Results open in a popup overlay.</p>
            <form id="trackForm" class="row g-2" autocomplete="off" novalidate>
              <div class="col-12">
                <label for="trackInput" class="visually-hidden">Order ID</label>
                <input id="trackInput" class="form-control form-control-lg" placeholder="Order ID" required />
              </div>
              <div class="col-12 d-grid d-sm-flex gap-2 align-items-center">
                <button class="btn btn-brand btn-lg px-4" type="submit" id="trackBtn">
                  <span class="spinner-border spinner-border-sm me-2 d-none" id="trackSpinner" aria-hidden="true"></span>
                  Track
                </button>
                <!-- Replaced copy link button with short industry text -->
                <span class="text-muted small">Trusted by businesses for reliable, on-time logistics visibility.</span>
              </div>
            </form>
          </div>
        </div>
        <!-- Visual -->
        <div class="col-lg-7">
          <div class="card-soft p-3 p-lg-4 h-100">
            <div class="banner">
              <img loading="lazy" src="https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?q=80&w=1600&auto=format&fit=crop" alt="Global logistics banner" />
            </div>
          </div>
        </div>
      </div>

      <!-- value props -->
      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <div class="feature">
            <div class="f-ico">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M2 12h8l3-9 2 18 3-9h4" stroke="#0B3B8C" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div class="fw-semibold">Global coverage</div>
              <div class="text-muted small">International lanes + domestic reach.</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="feature">
            <div class="f-ico">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 3" stroke="#0B3B8C" stroke-width="1.8" stroke-linecap="round"/><circle cx="12" cy="12" r="9" stroke="#0B3B8C" stroke-width="1.8"/></svg>
            </div>
            <div>
              <div class="fw-semibold">On-time visibility</div>
              <div class="text-muted small">Live tracking & proactive updates.</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="feature">
            <div class="f-ico">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3l7 3v6c0 5-3.5 8-7 9-3.5-1-7-4-7-9V6l7-3z" stroke="#0B3B8C" stroke-width="1.8" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div class="fw-semibold">Secure handling</div>
              <div class="text-muted small">Standardized scans & custody trails.</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- Services -->
  <section id="services" class="py-5">
    <div class="container">
      <h2 class="h4 fw-bold text-center mb-4">Services</h2>
      <div class="row g-4">
        <div class="col-md-6 col-lg-3">
          <div class="card-soft p-3 h-100">
            <div class="d-flex align-items-center gap-2">
              <div class="f-ico"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10h18M4 7h16l-1 10H5L4 7zM7 7V5a2 2 0 012-2h6a2 2 0 012 2v2" stroke="#0B3B8C" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
              <div class="fw-semibold">International Courier</div>
            </div>
            <div class="text-muted small mt-2">Door-to-door export/import, customs-ready paperwork.</div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="card-soft p-3 h-100">
            <div class="d-flex align-items-center gap-2">
              <div class="f-ico"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M2 12h6l3-4 3 4h8" stroke="#0B3B8C" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
              <div class="fw-semibold">Domestic Courier</div>
            </div>
            <div class="text-muted small mt-2">Surface & express options with reliable SLAs.</div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="card-soft p-3 h-100">
            <div class="d-flex align-items-center gap-2">
              <div class="f-ico"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 7h14l4 4v6a2 2 0 01-2 2H3V7z" stroke="#0B3B8C" stroke-width="1.6" stroke-linejoin="round"/><path d="M9 7v12M3 12h18" stroke="#0B3B8C" stroke-width="1.4"/></svg></div>
              <div class="fw-semibold">Business Cargo</div>
            </div>
            <div class="text-muted small mt-2">B2B cargo moves, palletized/LCL, documentation support.</div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="card-soft p-3 h-100">
            <div class="d-flex align-items-center gap-2">
              <div class="f-ico"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h5l2 3h9" stroke="#0B3B8C" stroke-width="1.6" stroke-linecap="round"/><circle cx="8" cy="18" r="2" stroke="#0B3B8C" stroke-width="1.6"/><circle cx="19" cy="18" r="2" stroke="#0B3B8C" stroke-width="1.6"/></svg></div>
              <div class="fw-semibold">Last-mile Delivery</div>
            </div>
            <div class="text-muted small mt-2">Urban delivery network with live visibility.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Brands -->
  <section id="brands" class="py-5">
    <div class="container">
      <h2 class="h5 fw-bold text-center mb-4">Our Brands & Businesses</h2>
      <div class="row g-3 brands">
        <div class="col-md-4">
          <a href="https://transo.delivery" target="_blank" class="d-block card-soft p-3">
            <div class="text-danger small mb-1">Last-mile</div>
            <div class="fw-semibold d-flex align-items-center justify-content-between">
              <span>transo.delivery</span><span class="chev">→</span>
            </div>
            <div class="text-muted small">Local delivery & post-purchase visibility.</div>
          </a>
        </div>
        <div class="col-md-4">
          <a href="https://translineholidays.com" target="_blank" class="d-block card-soft p-3">
            <div class="text-danger small mb-1">Travel</div>
            <div class="fw-semibold d-flex align-items-center justify-content-between">
              <span>Transline Holidays</span><span class="chev">→</span>
            </div>
            <div class="text-muted small">Tours, ticketing, curated holidays.</div>
          </a>
        </div>
        <div class="col-md-4">
          <a href="https://translinelogistics.in" target="_blank" class="d-block card-soft p-3">
            <div class="text-danger small mb-1">Logistics</div>
            <div class="fw-semibold d-flex align-items-center justify-content-between">
              <span>Transline Logistics</span><span class="chev">→</span>
            </div>
            <div class="text-muted small">Courier, cargo, customs, freight.</div>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Presence -->
  <section id="presence" class="py-5 bg-light">
    <div class="container">
      <h2 class="h5 fw-bold text-center mb-4">Presence</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card-soft p-3 h-100">
            <div class="text-muted small">Malappuram</div>
            <div class="fw-semibold">Kerala, India</div>
            <div class="small mt-1">+91 95398 22221<br/>transline@hansafgroup.com</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card-soft p-3 h-100">
            <div class="text-muted small">Delhi</div>
            <div class="fw-semibold">Mahipalpur, India</div>
            <div class="small mt-1">+91 95391 11145<br/>transline@hansafgroup.com</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card-soft p-3 h-100">
            <div class="text-muted small">Qatar</div>
            <div class="fw-semibold">Muaither, Doha</div>
            <div class="small mt-1">+974 70634373<br/>info@tradelinegroup.com</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="pt-3 pb-3">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
      <div class="footer-logo mb-3 mb-md-0">
        <img src="/assets/lg.png" alt="Transline Footer Logo" />
      </div>
      <div class="text-center text-md-end small">
        <p class="mb-1">© <span id="year"></span> Transline Cargo & Logistics. All rights reserved.</p>
        <p class="mb-0">Developed & Powered by <a href="https://iqtechsolutions.com" class="text-white" target="_blank">iqtechsolutions.com</a></p>
      </div>
    </div>
  </footer>

  <!-- Tracking Modal -->
  <div class="modal fade" id="trackModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Shipment Tracking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div id="uSkeleton" class="mt-2 d-none">
            <div class="skeleton mb-2" style="height:18px;width:45%;"></div>
            <div class="skeleton mb-2" style="height:18px;width:70%;"></div>
            <div class="skeleton mb-2" style="height:18px;width:60%;"></div>
          </div>

          <div id="uSummary" class="card-soft p-3 d-none">
            <div class="row g-3 summary-grid">
              <div class="col-6 col-lg-3"><div class="k">AWB</div><div class="v" id="uAwb">—</div></div>
              <div class="col-6 col-lg-3"><div class="k">Status</div><div class="v text-danger" id="uStatus">—</div></div>
              <div class="col-6 col-lg-3"><div class="k">Updated / ETA</div><div class="v" id="uWhen">—</div></div>
              <div class="col-6 col-lg-3"><div class="k">Location</div><div class="v" id="uLoc">—</div></div>
            </div>
            <div class="small text-muted mt-2" id="uNotes"></div>
          </div>

          <div id="uTimelineWrap" class="mt-3 d-none scroll-section">
            <h6 class="fw-semibold">Scan Timeline</h6>
            <div id="uTimeline" class="timeline"></div>
          </div>

          <div id="uEmpty" class="text-muted small">Enter an Order ID and press Track.</div>
          <div id="uError" class="text-danger small d-none"></div>
        </div>

        <div class="modal-footer">
          <!-- Replaced copy button with short industry line -->
          <div class="text-muted small">Industry-best practices for secure scanning and end-to-end visibility.</div>
          <button class="btn btn-brand" data-bs-dismiss="modal" type="button">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WhatsApp Chat Widget -->
  <div class="wa-widget" id="waWidget" aria-live="polite">
    <div class="wa-hint d-none d-sm-block">Chat with us</div>
    <a id="waLink" class="wa-bubble" target="_blank" rel="noopener">
      <svg viewBox="0 0 32 32" fill="none" aria-hidden="true">
        <path fill="#fff" d="M19.11 17.08c-.27-.14-1.57-.77-1.81-.86-.24-.09-.41-.14-.59.14-.18.27-.68.86-.83 1.03-.15.18-.31.2-.58.07-.27-.14-1.15-.42-2.2-1.33-.81-.72-1.35-1.61-1.51-1.88-.16-.27-.02-.42.12-.56.12-.12.27-.31.4-.47.13-.16.18-.27.27-.45.09-.18.05-.34-.02-.47-.07-.14-.59-1.42-.81-1.95-.21-.51-.43-.44-.59-.44-.15 0-.34-.02-.52-.02-.18 0-.47.07-.72.34-.25.27-.95.93-.95 2.27 0 1.34.98 2.63 1.12 2.81.14.18 1.93 2.95 4.66 4.02.65.27 1.16.43 1.56.55.65.21 1.24.18 1.71.11.52-.08 1.57-.64 1.79-1.26.22-.62.22-1.15.15-1.26-.07-.11-.25-.18-.52-.31z"/>
        <path fill="#fff" d="M26.72 5.3A12.66 12.66 0 0 0 16.01 1.6c-6.98 0-12.66 5.68-12.66 12.66 0 2.23.59 4.41 1.7 6.33l-1.81 6.61 6.78-1.78c1.86 1.02 3.97 1.56 6.16 1.56h.01c6.98 0 12.66-5.68 12.66-12.66 0-3.38-1.32-6.56-3.73-8.98zm-10.7 21.92h-.01a10.95 10.95 0 0 1-5.58-1.53l-.4-.24-4.02 1.05 1.07-3.91-.26-.4a10.96 10.96 0 1 1 9.2 4.03z"/>
      </svg>
      <span>WhatsApp</span>
    </a>
  </div>

  <script>
    (function(){
      var WHATSAPP_NUMBER = '+919539822221';
      var WHATSAPP_MESSAGE = encodeURIComponent("Hello Transline! I'd like to know more about your logistics services.");
      var l = document.getElementById('waLink');
      if(l){
        var num = WHATSAPP_NUMBER.replace(/[^\d]/g,'');
        l.href = 'https://wa.me/' + num + '?text=' + WHATSAPP_MESSAGE;
        var hint = document.querySelector('.wa-hint');
        if (hint) setTimeout(function(){ hint.style.display='none'; }, 5000);
      }
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Tracking logic: ORDER ID ONLY, with mobile/desktop reliability improvements -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    var SHEETS_ENDPOINT = '/sheets.php';
    var TRACK_PROXY     = '/track.php';
    var $ = function(id){ return document.getElementById(id); };
    var fmt = function(d){ try{ return new Date(d).toLocaleString(); }catch(_){ return d||'—'; } };
    var y = $('year'); if (y) y.textContent = new Date().getFullYear();

    // Header shadow
    document.addEventListener('scroll', function(){
      var h=$('siteHeader'); if(!h) return;
      if (window.scrollY>8) h.classList.add('scrolled'); else h.classList.remove('scrolled');
    });

    // Robust fetch with single retry on abort/timeout (helps mobile Safari)
    function getJSON(url, opts, timeoutMs){
      if (!opts) opts = {};
      opts.headers = Object.assign({'Accept':'application/json'}, opts.headers||{});
      opts.cache = 'no-store';
      opts.keepalive = true;

      function attempt(ms){
        var o = Object.assign({}, opts);
        var ctrl = (window.AbortController) ? new AbortController() : null;
        var timer = setTimeout(function(){ try{ if(ctrl) ctrl.abort(); }catch(e){} }, ms || 12000);
        if (ctrl) o.signal = ctrl.signal;
        return fetch(url, o).then(function(res){
          return res.text().then(function(txt){
            clearTimeout(timer);
            var j=null; try{ j = JSON.parse(txt); }catch(e){}
            return { ok: res.ok, status: res.status, json: j, text: txt };
          });
        }).catch(function(e){
          clearTimeout(timer);
          return { ok:false, status:0, json:null, text:String(e||'fail') };
        });
      }

      return attempt(timeoutMs || 12000).then(function(r){
        if (!r.ok && /AbortError|The operation was aborted|NetworkError|Failed to fetch/i.test(r.text || '')) {
          return attempt(18000);
        }
        return r;
      });
    }

    // Modal helpers
    function resetModal(){
      $('uSummary').classList.add('d-none');
      $('uTimelineWrap').classList.add('d-none');
      $('uTimeline').innerHTML = '';
      $('uSkeleton').classList.add('d-none');
      $('uEmpty').classList.remove('d-none');
      $('uError').classList.add('d-none');
      $('uAwb').textContent = '—';
      $('uStatus').textContent = '—';
      $('uWhen').textContent = '—';
      $('uLoc').textContent = '—';
      $('uNotes').textContent = '';
    }
    function showError(msg){
      $('uSkeleton').classList.add('d-none');
      $('uSummary').classList.add('d-none');
      $('uTimelineWrap').classList.add('d-none');
      $('uEmpty').classList.add('d-none');
      $('uError').classList.remove('d-none');
      $('uError').textContent = msg || 'Something went wrong.';
    }

    // Sheets (Order ID only)
    function getSheetById(orderId){
      return getJSON(SHEETS_ENDPOINT + '?id=' + encodeURIComponent(orderId), null, 8000)
        .then(function(r){ return (r.ok && r.json && (r.json.ok===true || r.json.ok==='true') && r.json.data) ? r.json.data : null; })
        ["catch"](function(){ return null; });
    }

    // Carrier (Order ID only; normalize + pick ReferenceNo)
    function normalizeCarrier(json){
      if (!json) return null;
      var sd = Array.isArray(json.ShipmentData) ? json.ShipmentData : [];
      var ship = sd.length ? (sd[0].Shipment || sd[0]) : null;
      if (!ship) return null;
      var st = ship.Status || ship.CurrentStatus || {};
      var awb = ship.AWB || ship.Waybill || ship.WayBill || ship.awb || '';
      var status = st.Status || st.status || '';
      var whenRaw = st.StatusDateTime || st.StatusDate || st.ReceivedOn || '';
      var location = st.StatusLocation || ship.Origin || '';
      var orderId = ship.ReferenceNo || ship.reference_no || ship.RefNo || '';

      var scansSrc = ship.Scans || [];
      var scans = [];
      if (Array.isArray(scansSrc)){
        for (var i=0;i<scansSrc.length;i++){
          var x = scansSrc[i].ScanDetail || scansSrc[i];
          scans.push({
            time: x.StatusDateTime || x.ScanDateTime || x.EventDateTime || x.time || x.date || '',
            text: x.Scan || x.Status || x.Event || 'Update',
            location: x.ScannedLocation || x.StatusLocation || x.location || x.Origin || x.Destination || '',
            note: x.Instructions || x.Remarks || x.note || ''
          });
        }
      }
      return { entry: { awb: awb, status: status, when: whenRaw, location: location, scans: scans, orderId: orderId } };
    }
    function getCarrierById(orderId){
      return getJSON(TRACK_PROXY + '?id=' + encodeURIComponent(orderId), null, 12000)
        .then(function(r){ return (r.ok && r.json) ? normalizeCarrier(r.json) : null; })
        ["catch"](function(){ return null; });
    }

    // Merge render
    function renderMerged(orderId, sheet, carrier){
      $('uSkeleton').classList.add('d-none');
      $('uEmpty').classList.add('d-none');
      $('uSummary').classList.remove('d-none');

      var delAwb = carrier && carrier.entry ? (carrier.entry.awb || '') : '';
      var delStat= carrier && carrier.entry ? (carrier.entry.status || '') : '';
      var delWhen= carrier && carrier.entry && carrier.entry.when ? fmt(carrier.entry.when) : '';
      var delLoc = carrier && carrier.entry ? (carrier.entry.location || '') : '';
      var delOrder = carrier && carrier.entry ? (carrier.entry.orderId || '') : '';
      var scans  = (carrier && carrier.entry && Array.isArray(carrier.entry.scans)) ? carrier.entry.scans.slice() : [];

      var sheetAwb   = sheet && sheet.awb ? String(sheet.awb) : '';
      var sheetEta   = sheet && sheet.expectedDate ? ('ETA ' + sheet.expectedDate) : '';
      var sheetStatus= sheet && sheet.status ? sheet.status : '';
      var sheetNotes = sheet && sheet.notes ? sheet.notes : '';
      var sheetId    = sheet && sheet.id ? String(sheet.id) : '';

      var primaryAwb = delAwb || sheetAwb || '—';
      var status = delStat || sheetStatus || '—';
      var when   = (delWhen || '') + (sheetEta ? (delWhen ? (' • ' + sheetEta) : sheetEta) : '');
      var loc    = delLoc || '—';

      $('uAwb').textContent    = primaryAwb;
      $('uStatus').textContent = status;
      $('uWhen').textContent   = when || '—';
      $('uLoc').textContent    = loc;

      var idBits = [];
      var displayId = sheetId || delOrder || orderId;
      if (displayId) idBits.push('Order ID: ' + displayId);
      if (sheetAwb && (!delAwb || sheetAwb.toUpperCase() !== delAwb.toUpperCase())) idBits.push('Sheet AWB: ' + sheetAwb);
      if (delAwb) idBits.push('Carrier AWB: ' + delAwb);
      var extra = sheetNotes ? ('Notes: ' + sheetNotes) : '';
      $('uNotes').textContent = (idBits.length ? idBits.join(' • ') : '') + (extra ? (idBits.length ? ' • ' : '') + extra : '');

      if (scans.length){
        $('uTimelineWrap').classList.remove('d-none');
        scans.sort(function(a,b){ return new Date(b.time||0) - new Date(a.time||0); });
        for (var i=0;i<scans.length;i++){
          var s = scans[i];
          var row = document.createElement('div');
          row.className='timeline-item py-2';
          row.innerHTML =
            '<div class="d-flex justify-content-between">'
            + '<div class="fw-semibold">'+ (s.text || 'Update') +'</div>'
            + '<div class="text-muted small">'+ (s.time ? fmt(s.time) : '') +'</div>'
            + '</div>'
            + '<div class="small text-muted">'+ (s.location || '') +'</div>'
            + (s.note ? '<div class="small text-danger">'+ s.note +'</div>' : '');
          $('uTimeline').appendChild(row);
        }
      }

      // Save ID in case needed later
      lastOrderId = displayId || '';
    }

    // Form wiring
    var form=$('trackForm'), input=$('trackInput'), btn=$('trackBtn'), spin=$('trackSpinner');
    var cache = new Map ? new Map() : {};
    var lastOrderId='';

    form.addEventListener('submit', function(e){ e.preventDefault(); });

    form.addEventListener('submit', function(){
      var raw = (input.value||'').trim();
      if (!raw){ input.focus(); return; }
      // Sanitize order id for mobile keyboards (remove zero-width, trim)
      var orderId = raw.replace(/[\u200B-\u200D\uFEFF]/g,'').split(',').map(function(s){return s.trim();}).filter(Boolean)[0];

      resetModal();
      $('uSkeleton').classList.remove('d-none');
      (bootstrap.Modal.getInstance(document.getElementById('trackModal')) || new bootstrap.Modal(document.getElementById('trackModal'), { backdrop:'static', keyboard:true })).show();
      spin.classList.remove('d-none'); btn.disabled = true;

      function cHas(k){ return cache instanceof Map ? cache.has(k) : (cache[k]!==undefined); }
      function cGet(k){ return cache instanceof Map ? cache.get(k) : cache[k]; }
      function cSet(k,v){ if(cache instanceof Map) cache.set(k,v); else cache[k]=v; }

      try{
        if (cHas(orderId)){
          var pref = cGet(orderId);
          renderMerged(orderId, pref.sheet, pref.carrier);
          spin.classList.add('d-none'); btn.disabled = false;
          return;
        }

        var pSheet   = getSheetById(orderId);
        var pCarrier = getCarrierById(orderId);

        // Early paint from Sheet to feel fast
        pSheet.then(function(s){
          if (!s) return;
          if (!$('uSummary').classList.contains('d-none')) return;
          $('uSkeleton').classList.add('d-none');
          $('uSummary').classList.remove('d-none');
          $('uEmpty').classList.add('d-none');
          $('uAwb').textContent    = (s.awb || '—');
          $('uStatus').textContent = (s.status || '—');
          $('uWhen').textContent   = (s.expectedDate ? ('ETA ' + s.expectedDate) : '—');
          $('uLoc').textContent    = '—';
          var bits = [];
          if (s.id) bits.push('Order ID: ' + s.id);
          if (s.notes) bits.push('Notes: ' + s.notes);
          $('uNotes').textContent  = bits.join(' • ');
        })["catch"](function(){});

        Promise.allSettled([pSheet, pCarrier]).then(function(rs){
          var sheet   = rs[0] && rs[0].status==='fulfilled' ? rs[0].value : null;
          var carrier = rs[1] && rs[1].status==='fulfilled' ? rs[1].value : null;

          cSet(orderId, { sheet:sheet, carrier:carrier });

          if (!sheet && !carrier){
            $('uSkeleton').classList.add('d-none');
            $('uEmpty').classList.remove('d-none');
            $('uEmpty').textContent = 'No data found for this Order ID.';
          } else {
            renderMerged(orderId, sheet, carrier);
          }
        })["finally"](function(){
          spin.classList.add('d-none'); btn.disabled = false;
        });
      }catch(err){
        showError('Tracking failed.');
        spin.classList.add('d-none'); btn.disabled = false;
      }
    });
  });
  </script>
</body>
</html>
